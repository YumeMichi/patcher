From 39d75f662aea48c969e5ea954910e6d105057085 Mon Sep 17 00:00:00 2001
From: Rohon Das <rohodas@codeaurora.org>
Date: Wed, 28 Jul 2021 11:11:49 +0530
Subject: [PATCH 21/21] [Q_asb_2022-02] Fix SIGSEGV during Hands-free client
 SDP

Change-Id: I1a4c6cc1bbb22dfc31ee9ca5f7a252b208af627c
---
 bta/hf_client/bta_hf_client_main.cc | 2 +-
 bta/hf_client/bta_hf_client_rfc.cc  | 2 +-
 bta/hf_client/bta_hf_client_sdp.cc  | 5 +++--
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/bta/hf_client/bta_hf_client_main.cc b/bta/hf_client/bta_hf_client_main.cc
index b2290a2fc1..c849f7c1f4 100644
--- a/bta/hf_client/bta_hf_client_main.cc
+++ b/bta/hf_client/bta_hf_client_main.cc
@@ -381,7 +381,7 @@ void bta_hf_client_collision_cback(UNUSED_ATTR tBTA_SYS_CONN_STATUS status,
     /* Cancel SDP if it had been started. */
     if (client_cb->p_disc_db) {
       (void)SDP_CancelServiceSearch(client_cb->p_disc_db);
-      bta_hf_client_free_db(NULL);
+      osi_free_and_reset((void**)&client_cb->p_disc_db);
     }
 
     /* reopen registered server */
diff --git a/bta/hf_client/bta_hf_client_rfc.cc b/bta/hf_client/bta_hf_client_rfc.cc
index 3e2aa5927c..b2a4644aca 100644
--- a/bta/hf_client/bta_hf_client_rfc.cc
+++ b/bta/hf_client/bta_hf_client_rfc.cc
@@ -284,7 +284,7 @@ void bta_hf_client_rfc_do_close(tBTA_HF_CLIENT_DATA* p_data) {
     /* Cancel SDP if it had been started. */
     if (client_cb->p_disc_db) {
       (void)SDP_CancelServiceSearch(client_cb->p_disc_db);
-      bta_hf_client_free_db(NULL);
+      osi_free_and_reset((void**)&client_cb->p_disc_db);
     }
   }
 }
diff --git a/bta/hf_client/bta_hf_client_sdp.cc b/bta/hf_client/bta_hf_client_sdp.cc
index 6feb1885fe..3988f4345b 100644
--- a/bta/hf_client/bta_hf_client_sdp.cc
+++ b/bta/hf_client/bta_hf_client_sdp.cc
@@ -25,7 +25,7 @@
  ******************************************************************************/
 
 #include <string.h>
-
+#include <base/logging.h>
 #include "bt_utils.h"
 #include "bta_api.h"
 #include "bta_hf_client_api.h"
@@ -331,7 +331,7 @@ void bta_hf_client_do_disc(tBTA_HF_CLIENT_CB* client_cb) {
 
   if (!db_inited) {
     /*free discover db */
-    bta_hf_client_free_db(NULL);
+    osi_free_and_reset((void**)&client_cb->p_disc_db);
     /* sent failed event */
     tBTA_HF_CLIENT_DATA msg;
     msg.hdr.layer_specific = client_cb->handle;
@@ -350,6 +350,7 @@ void bta_hf_client_do_disc(tBTA_HF_CLIENT_CB* client_cb) {
  *
  ******************************************************************************/
 void bta_hf_client_free_db(tBTA_HF_CLIENT_DATA* p_data) {
+  CHECK(p_data != NULL);
   tBTA_HF_CLIENT_CB* client_cb =
       bta_hf_client_find_cb_by_handle(p_data->hdr.layer_specific);
   if (client_cb == NULL) {
-- 
2.35.1

