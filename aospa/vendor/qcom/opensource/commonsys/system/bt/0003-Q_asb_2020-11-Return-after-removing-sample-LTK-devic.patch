From 64f99c9cb70813ee7623df0789d0b317a2ced6f5 Mon Sep 17 00:00:00 2001
From: "li-wei.cheng" <li-wei.cheng@mediatek.com>
Date: Mon, 20 Jan 2020 15:27:21 +0800
Subject: [PATCH 03/18] [Q_asb_2020-11] Return after removing sample LTK device

Return directly after calling bta_dm_remove_device to
prevent from accessing the invalid security record (p_dev_rec).

Test: Hardcode to test bond with sample key
Tag: #security
Bug: 162497143
Change-Id: Iaa59f3c415dd8066849fd70912fdb83f890229d7
(cherry picked from commit 7c86810c44ef2efd97c3e78bd77e36257a05f75b)
---
 stack/btm/btm_sec.cc | 1 +
 1 file changed, 1 insertion(+)

diff --git a/stack/btm/btm_sec.cc b/stack/btm/btm_sec.cc
index 9adec96a0..28594e937 100644
--- a/stack/btm/btm_sec.cc
+++ b/stack/btm/btm_sec.cc
@@ -4829,6 +4829,7 @@ void btm_sec_disconnected(uint16_t handle, uint8_t reason) {
     tBTA_DM_MSG p_data;
     p_data.remove_dev.bd_addr = p_dev_rec->bd_addr;
     bta_dm_remove_device(&p_data);
+    return;
   }
 
   if (p_dev_rec->sec_state == BTM_SEC_STATE_DISCONNECTING_BOTH) {
-- 
2.34.1

