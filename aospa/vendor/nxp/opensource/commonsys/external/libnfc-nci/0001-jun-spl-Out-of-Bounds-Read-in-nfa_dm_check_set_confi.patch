From 5bb07645f774394192e4ad4baca98931c2953abc Mon Sep 17 00:00:00 2001
From: Alisher Alikhodjaev <alisher@google.com>
Date: Thu, 17 Mar 2022 15:39:20 -0700
Subject: [PATCH 1/3] [jun-spl] Out of Bounds Read in nfa_dm_check_set_config

Bug: 221216105
Test: build ok
Change-Id: I1930de8531f6c15e6be400a7b1ab3e7cf86b4229
(cherry picked from commit 88c5c267e889699c71412022e3fcb03d20100e99)
Merged-In: I1930de8531f6c15e6be400a7b1ab3e7cf86b4229
---
 SN100x/src/nfa/dm/nfa_dm_main.cc | 7 +++++++
 src/nfa/dm/nfa_dm_main.cc        | 7 +++++++
 2 files changed, 14 insertions(+)

diff --git a/SN100x/src/nfa/dm/nfa_dm_main.cc b/SN100x/src/nfa/dm/nfa_dm_main.cc
index 53b4511e..c67f0e26 100755
--- a/SN100x/src/nfa/dm/nfa_dm_main.cc
+++ b/SN100x/src/nfa/dm/nfa_dm_main.cc
@@ -44,6 +44,7 @@
 
 #include <android-base/stringprintf.h>
 #include <base/logging.h>
+#include <log/log.h>
 
 #include "nfa_api.h"
 #include "nfa_dm_int.h"
@@ -270,6 +271,12 @@ tNFA_STATUS nfa_dm_check_set_config(uint8_t tlv_list_len, uint8_t* p_tlv_list,
     len = *(p_tlv_list + xx + 1);
     p_value = p_tlv_list + xx + 2;
     p_cur_len = nullptr;
+    if (len > (tlv_list_len - xx - 2)) {
+      LOG(ERROR) << StringPrintf("error: invalid TLV length: t:0x%x, l:%d",
+                                 type, len);
+      android_errorWriteLog(0x534e4554, "221216105");
+      return NFA_STATUS_FAILED;
+    }
 
     switch (type) {
       /*
diff --git a/src/nfa/dm/nfa_dm_main.cc b/src/nfa/dm/nfa_dm_main.cc
index 261a0b2a..c21c63ef 100755
--- a/src/nfa/dm/nfa_dm_main.cc
+++ b/src/nfa/dm/nfa_dm_main.cc
@@ -45,6 +45,7 @@
 
 #include <android-base/stringprintf.h>
 #include <base/logging.h>
+#include <log/log.h>
 
 #include "nfa_api.h"
 #include "nfa_dm_int.h"
@@ -281,6 +282,12 @@ tNFA_STATUS nfa_dm_check_set_config(uint8_t tlv_list_len, uint8_t* p_tlv_list,
     len = *(p_tlv_list + xx + 1);
     p_value = p_tlv_list + xx + 2;
     p_cur_len = nullptr;
+    if (len > (tlv_list_len - xx - 2)) {
+      LOG(ERROR) << StringPrintf("error: invalid TLV length: t:0x%x, l:%d",
+                                 type, len);
+      android_errorWriteLog(0x534e4554, "221216105");
+      return NFA_STATUS_FAILED;
+    }
 
     switch (type) {
       /*
-- 
2.36.1

