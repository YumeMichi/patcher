From 224acd0956b01c9e3a41223964d1d3d7e8838750 Mon Sep 17 00:00:00 2001
From: John Shao <johnshao@google.com>
Date: Wed, 23 Dec 2020 22:21:30 +0000
Subject: [PATCH 1/2] [Q_asb_2021-04] Prevent overlays on vCard import flows

Bug: 172252122
Test: manual with POC
Change-Id: I69c46f073f324005c3dd214447792fc20fe75a2b
Merged-In: I69c46f073f324005c3dd214447792fc20fe75a2b
(cherry picked from commit aa189a0daadf4d4cd8e00895c9bdbb8ac0ec9bb6)
(cherry picked from commit b423fdf941a10fc1498dcee0665e56fb1856bf4e)
---
 Android.mk                                                | 2 +-
 AndroidManifest.xml                                       | 1 +
 src/com/android/contacts/vcard/ImportVCardActivity.java   | 3 +++
 src/com/android/contacts/vcard/SelectAccountActivity.java | 3 +++
 4 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/Android.mk b/Android.mk
index 9e5552fb8..b5393c3cf 100644
--- a/Android.mk
+++ b/Android.mk
@@ -46,7 +46,7 @@ LOCAL_REQUIRED_MODULES := privapp_whitelist_com.android.contacts
 LOCAL_PROGUARD_FLAG_FILES := proguard.flags
 
 LOCAL_PRIVATE_PLATFORM_APIS := true
-#LOCAL_SDK_VERSION := current
+#LOCAL_SDK_VERSION := system_current
 LOCAL_MIN_SDK_VERSION := 21
 
 include $(BUILD_PACKAGE)
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 1395823e1..882599810 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -53,6 +53,7 @@
     <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
     <!-- Required in P to run Service.startForeground() -->
     <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
+    <uses-permission android:name="android.permission.HIDE_NON_SYSTEM_OVERLAY_WINDOWS" />
 
     <uses-feature
         android:name="android.hardware.telephony"
diff --git a/src/com/android/contacts/vcard/ImportVCardActivity.java b/src/com/android/contacts/vcard/ImportVCardActivity.java
index 035371629..81ff3bb23 100755
--- a/src/com/android/contacts/vcard/ImportVCardActivity.java
+++ b/src/com/android/contacts/vcard/ImportVCardActivity.java
@@ -546,6 +546,9 @@ public class ImportVCardActivity extends Activity implements ImportVCardDialogFr
     protected void onCreate(Bundle bundle) {
         super.onCreate(bundle);
 
+        getWindow().addSystemFlags(android.view.WindowManager.LayoutParams
+            .SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS);
+
         Uri sourceUri = getIntent().getData();
 
         // Reading uris from non-storage needs the permission granted from the source intent,
diff --git a/src/com/android/contacts/vcard/SelectAccountActivity.java b/src/com/android/contacts/vcard/SelectAccountActivity.java
index ac5b3eb71..eb13e505c 100644
--- a/src/com/android/contacts/vcard/SelectAccountActivity.java
+++ b/src/com/android/contacts/vcard/SelectAccountActivity.java
@@ -52,6 +52,9 @@ public class SelectAccountActivity extends Activity {
     protected void onCreate(Bundle bundle) {
         super.onCreate(bundle);
 
+        getWindow().addSystemFlags(android.view.WindowManager.LayoutParams
+            .SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS);
+
         // There's three possibilities:
         // - more than one accounts -> ask the user
         // - just one account -> use the account without asking the user
-- 
2.34.1

